<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>N3XUS LEAKS</title>
  <!-- Tab icon, set dynamically via admin -->
  <link rel="icon" id="favicon" href=""/>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,600,700&display=swap" rel="stylesheet"/>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <!-- JSZip for admin uploads -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>

  <style>
    :root {
      --bg-dark: #0d0d0f;
      --bg-darker: #131318;
      --text-light: #e1e1e6;
      --text-muted: #7a7a8c;
      --accent: #e6007e;
      --accent-hover: #ff1a95;
      --sidebar-width: 240px;
    }
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Montserrat',sans-serif; }
    body { display:flex; min-height:100vh; background:var(--bg-dark); color:var(--text-light); }
    a { text-decoration:none; color:inherit; }
    button { border:2px solid var(--accent); border-radius:6px; background:none; color:var(--accent); cursor:pointer; transition: box-shadow .2s, background .2s, color .2s; }
    button:hover { box-shadow: 0 0 8px var(--accent-hover); background:var(--accent); color:#fff; }

    .sidebar { position:fixed; top:0; left:0; width:var(--sidebar-width); height:100%; background:var(--bg-darker); display:flex; flex-direction:column; padding-top:20px; }
    .sidebar ul { list-style:none; padding:0 20px; }
    .sidebar li + li { margin-top:12px; }
    .sidebar li a { display:flex; align-items:center; padding:12px 16px; border-radius:4px; transition: background .2s; }
    .sidebar li a:hover, .sidebar li a.active { background: rgba(230,0,126,0.1); }
    .sidebar i { margin-right:12px; font-size:18px; }

    .main { margin-left:var(--sidebar-width); flex:1; display:flex; flex-direction:column; }
    .header { height:60px; background:var(--bg-darker); display:flex; align-items:center; justify-content:space-between; padding:0 20px; }
    #search-controls { display:flex; align-items:center; }
    #search-form { display:flex; align-items:center; }
    #search-input, #jpg5-input { padding:6px 10px; font-size:14px; border:none; border-radius:4px; width:200px; }
    #jpg5-input { margin-left:8px; width:250px; }
    #search-btn, #jpg5-btn { padding:6px 12px; border-radius:4px; background:var(--accent); color:#fff; margin-left:4px; }
    .header-btn { display:flex; align-items:center; justify-content:center; width:44px; height:44px; border-radius:6px; font-size:22px; margin-left:8px; }

    #intro { padding:60px 40px; text-align:center; animation: fadeIn 1.5s ease-in; }
    #intro h2 { font-size:36px; color:var(--accent); margin-bottom:16px; animation: slideDown 1s ease-out; }
    #intro p { color:var(--text-muted); line-height:1.5; max-width:600px; margin:0 auto; }
    @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    @keyframes slideDown { from { transform:translateY(-20px); opacity:0; } to { transform:translateY(0); opacity:1; } }

    #img-context-menu { position: fixed; background: #112240; border: 1px solid #233554; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.7); color: #ccd6f6; display: none; z-index: 10000; }
    #img-context-menu div { padding: 8px 12px; cursor: pointer; white-space: nowrap; }
    #img-context-menu div:hover { background: #233554; }
    .content { flex:1; overflow-y:auto; padding-top:20px; }

    #search-section { display:none; padding:20px 40px; }
    .search-cards { display:grid; gap:16px; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); }

    .models-section { padding:20px 40px; display:none; }
    #model-list-tools { display:flex; align-items:center; flex-wrap:wrap; gap:8px; margin-bottom:16px; }
    #model-filter-input { padding:6px 10px; font-size:14px; border:none; border-radius:4px; width:200px; }
    #model-az-list button { background:none; border:none; color:var(--accent); cursor:pointer; font-size:14px; padding:4px 6px; border-radius:4px; transition:background .2s; }
    #model-az-list button:hover { background:rgba(230,0,126,0.1); }

    .model-cards { display:grid; gap:16px; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); }
    .model-card { position: relative; background:var(--bg-darker); border-radius:4px; overflow:hidden; cursor:pointer; transition:transform .1s; }
    .model-card:hover { transform:scale(1.02); }
    .model-card img { width:100%; height:100px; object-fit:cover; }
    .model-card .info { padding:8px; text-align:center; }
    .model-card .info h3 { font-size:14px; margin-bottom:4px; color:var(--text-light); }
    .model-card .info p { font-size:12px; color:var(--text-muted); }
    .delete-model-btn {
      position:absolute; top:8px; right:8px; background:none; border:none; font-size:16px; color:var(--accent);
      padding:4px; border-radius:50%; transition:background .2s;
    }
    .delete-model-btn:hover { background:rgba(230,0,126,0.2); }

    #gallery-view { display:none; padding:20px 40px; }
    #back-btn { background:none; border:none; color:var(--accent); cursor:pointer; margin-bottom:16px; font-size:14px; }
    .endpoint-section { margin-bottom:24px; }
    .endpoint-section h3 { font-size:18px; margin-bottom:8px; color:var(--accent); display:inline-block; }
    .items-grid { display:grid; gap:16px; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); }
    .items-grid .item-container { position:relative; }
    .items-grid img { width:100%; height:auto; border-radius:4px; display:block; }
    .item-btn {
      position:absolute; top:4px; right:4px; background:none; border:none; font-size:14px; color:var(--accent);
      padding:2px 4px; border-radius:4px; transition:background .2s;
      margin-left:4px;
    }
    .item-btn:hover { background:rgba(230,0,126,0.2); }

    .accordion { max-width:800px; margin:40px auto; }
    .accordion-item { background:var(--bg-darker); border-radius:4px; margin-bottom:16px; overflow:hidden; }
    .accordion-item button { width:100%; background:none; border:none; color:var(--text-light); text-align:left; padding:20px; font-size:16px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; transition: background .2s; }
    .accordion-item button:hover { background:rgba(255,255,255,0.05); }
    .accordion-item button i { font-size:20px; transition:transform .3s; }
    .panel { max-height:0; overflow:hidden; transition:max-height .3s ease; background:var(--bg-dark); }
    .panel p { padding:0 20px 20px; color:var(--text-muted); }

    #terms { max-width:800px; margin:40px auto; color:var(--text-muted); line-height:1.5; padding:0 20px; }

    .footer { background:var(--bg-darker); padding:40px 20px; color:var(--text-muted); display:flex; justify-content:space-between; flex-wrap:wrap; }
    .footer .left { max-width:600px; }
    .footer .left h3 { color:#fff; margin-bottom:8px; }
    .footer .links { list-style:none; display:flex; flex-wrap:wrap; margin-top:16px; }
    .footer .links li { margin-right:16px; margin-bottom:8px; }
    .footer .payments i { margin-right:12px; font-size:24px; }

    .back-to-top { position:fixed; bottom:20px; right:50%; transform:translateX(50%); background:var(--accent); width:48px; height:48px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; cursor:pointer; transition:background .2s; }
    .back-to-top:hover { background:var(--accent-hover); }

    #admin-panel {
      display:none; position:fixed; top:60px; right:20px;
      background:var(--bg-darker); padding:20px; border:2px solid var(--accent);
      border-radius:6px; z-index:1000; width:260px;
    }
    #admin-panel h3 { margin-bottom:12px; color:var(--accent); }
    #admin-panel input { width:100%; padding:6px 10px; margin-bottom:8px; border:none; border-radius:4px; }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar">
    <ul>
      <li><a href="#" id="menu-home" class="active"><i class="fas fa-star"></i> Home</a></li>
      <li><a href="#" id="menu-search"><i class="fas fa-search"></i> Search</a></li>
      <li><a href="#" id="menu-models"><i class="fas fa-user"></i> Models</a></li>
      <li><a href="#" id="menu-faq"><i class="fas fa-question-circle"></i> FAQ</a></li>
      <li><a href="#" id="menu-terms"><i class="fas fa-file-alt"></i> Terms</a></li>
    </ul>
  </aside>

  <!-- Main panel -->
  <div class="main">
    <header class="header">
      <h1 style="color:var(--accent);">N3XUS LEAKS</h1>
      <div id="search-controls">
        <form id="search-form">
          <input id="search-input" placeholder="Search term…" autocomplete="off"/>
          <button type="submit" id="search-btn"><i class="fas fa-search"></i></button>
        </form>
        <input id="jpg5-input" placeholder="JPG5 album URL…" autocomplete="off"/>
        <button id="jpg5-btn">Fetch JPG5</button>
      </div>
      <button id="telegram-btn" class="header-btn"><i class="fab fa-telegram-plane"></i></button>
      <button id="discord-btn" class="header-btn"><i class="fab fa-discord"></i></button>
    </header>

    <div class="content">
      <!-- Home Intro -->
      <section id="intro">
        <h2>Welcome to N3XUS LEAKS</h2>
        <p>
          Search any creator name and instantly pull galleries across multiple leak-sites.
          The results are stored locally so you can browse even if the internet goes down.
          Simply enter a search term above and view thumbnails; click a card to open all links.
        </p>
      </section>

      <!-- Search Section -->
      <section id="search-section">
        <h2>Search Results</h2>
        <div class="search-cards" id="search-grid"></div>
      </section>

      <!-- Models Section -->
      <section class="models-section" id="models-section">
        <div id="model-list-tools">
          <input id="model-filter-input" type="text" placeholder="Filter models…"/>
          <div id="model-az-list"></div>
        </div>
        <div class="model-cards" id="models-grid"></div>
      </section>

      <!-- Gallery / Album Links View -->
      <section id="gallery-view">
        <button id="back-btn"><i class="fas fa-arrow-left"></i> Back</button>
        <h2 id="model-title"></h2>
        <div id="album-links"></div>
      </section>

      <!-- FAQ -->
      <section id="faq" class="accordion">
        <div class="accordion-item">
          <button>What does this site do? <i class="fas fa-plus"></i></button>
          <div class="panel"><p>Aggregates publicly-available galleries from multiple sources. Search any term to see results.</p></div>
        </div>
        <div class="accordion-item">
          <button>How does offline work? <i class="fas fa-plus"></i></button>
          <div class="panel"><p>Results are saved in your browser’s LocalStorage so you can revisit them without reloading.</p></div>
        </div>
        <div class="accordion-item">
          <button>Is this legal? <i class="fas fa-plus"></i></button>
          <div class="panel"><p>We simply link to public content. We do not host any copyrighted material.</p></div>
        </div>
      </section>

      <!-- Terms -->
      <section id="terms">
        <h2>Terms &amp; Conditions</h2>
        <p>By using this site you agree not to redistribute copyrighted content. N3XUS LEAKS is not responsible for external site availability.</p>
      </section>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="left">
        <h3>N3XUS LEAKS</h3>
        <p>Your one-stop aggregator for leak galleries across the web. No subscriptions, no logins—just search and browse.</p>
        <ul class="links">
          <li><a href="#" id="faq-link">FAQ</a></li>
          <li><a href="#" id="terms-link">Terms</a></li>
          <li><a href="#">Privacy</a></li>
          <li><a href="#">Contact</a></li>
        </ul>
        <div class="payments">
          <i class="fab fa-bitcoin"></i>
          <i class="fas fa-dollar-sign"></i>
          <i class="fab fa-cc-paypal"></i>
          <i class="fab fa-cc-visa"></i>
          <i class="fab fa-cc-mastercard"></i>
          <i class="fab fa-cc-amex"></i>
        </div>
      </div>
    </footer>
  </div>

  <div id="img-context-menu">
    <div data-action="copy-image">Copy Image</div>
    <div data-action="copy-url">Copy Image URL</div>
    <div data-action="open">Open Image in New Tab</div>
  </div>
  <div class="back-to-top"><i class="fas fa-arrow-up"></i></div>

  <!-- Admin Panel (hidden until Ctrl+I) -->
  <div id="admin-panel">
    <h3>Admin Panel</h3>
    <input id="new-model-name" type="text" placeholder="Model Name" />
    <input id="new-model-zip" type="file" accept=".zip" />
    <button id="upload-btn">Upload Model</button>
    <hr style="border-color:var(--accent);" />
    <input id="favicon-url" type="text" placeholder="Tab Icon URL" />
    <button id="set-favicon-btn">Set Tab Icon</button>
  </div>

  <script>
    // Constants & state
    const DEFAULT_THUMB = 'https://media.discordapp.net/attachments/1343576085098664020/1364464992593772644/raw.png?ex=6809c48c&is=6808730c&hm=247618a2250c26ecc847f71e96ca4467dae31fded42aa8245b0ab914e4d10ea6&=&format=webp&quality=lossless&width=882&height=882';
    let results = JSON.parse(localStorage.getItem('n3xus_results') || '[]');
    let adminMode = false;

    // Element refs
    const menuHome       = document.getElementById('menu-home'),
          menuSearch     = document.getElementById('menu-search'),
          menuModels     = document.getElementById('menu-models'),
          menuFaq        = document.getElementById('menu-faq'),
          menuTerms      = document.getElementById('menu-terms'),
          intro          = document.getElementById('intro'),
          searchSec      = document.getElementById('search-section'),
          modelsSec      = document.getElementById('models-section'),
          galleryView    = document.getElementById('gallery-view'),
          faqSec         = document.getElementById('faq'),
          termsSec       = document.getElementById('terms'),
          searchForm     = document.getElementById('search-form'),
          searchIn       = document.getElementById('search-input'),
          searchGrid     = document.getElementById('search-grid'),
          modelsGrid     = document.getElementById('models-grid'),
          backBtn        = document.getElementById('back-btn'),
          modelTitle     = document.getElementById('model-title'),
          albumLinks     = document.getElementById('album-links'),
          faqBtns        = document.querySelectorAll('.accordion-item button'),
          backToTop      = document.querySelector('.back-to-top'),
          telegramBtn    = document.getElementById('telegram-btn'),
          discordBtn     = document.getElementById('discord-btn'),
          azList         = document.getElementById('model-az-list'),
          filterIn       = document.getElementById('model-filter-input'),
          jpg5Input      = document.getElementById('jpg5-input'),
          jpg5Btn        = document.getElementById('jpg5-btn'),
          uploadBtn      = document.getElementById('upload-btn'),
          adminPanel     = document.getElementById('admin-panel'),
          faviconLink    = document.getElementById('favicon'),
          setFaviconBtn  = document.getElementById('set-favicon-btn'),
          faviconInput   = document.getElementById('favicon-url');

    // All endpoints
    const endpoints = [
      { name:'Erome Gallery',   url:q=>`/api/erome-gallery?query=${q}`,       type:'gallery' },
      { name:'Erome Albums',    url:q=>`/api/erome-albums?username=${q}`,     type:'albums'  },
      { name:'Bunkr Gallery',   url:q=>`/api/bunkr-gallery?query=${q}`,       type:'gallery' },
      { name:'Bunkr Albums',    url:q=>`/api/bunkr-albums?query=${q}`,        type:'albums'  },
      { name:'NotFans',         url:q=>`/api/notfans?search_term=${q}`,       type:'urls',   key:['urls','titles'] },
      { name:'Influencers',     url:q=>`/api/influencers?term=${q}`,          type:'urls',   key:['urls','titles'] },
      { name:'Thothub',         url:q=>`/api/thothub?term=${q}`,              type:'urls',   key:['urls','titles'] },
      { name:'DirtyShip',       url:q=>`/api/dirtyship?term=${q}`,            type:'urls',   key:['urls','titles'] },
      { name:'PimpBunny',       url:q=>`/api/pimpbunny?term=${q}`,            type:'urls',   key:['urls','titles'] },
      { name:'LeakedZone',      url:q=>`/api/leakedzone?term=${q}`,           type:'urls',   key:['urls','titles'] },
      { name:'FanslyLeaked',    url:q=>`/api/fanslyleaked?term=${q}`,         type:'urls',   key:['urls','titles'] },
      { name:'GotAnyNudes',     url:q=>`/api/gotanynudes?term=${q}`,          type:'urls',   key:['urls','titles'] },
      { name:'NSFW247',         url:q=>`/api/nsfw247?term=${q}`,             type:'urls',   key:['urls','titles'] },
      { name:'HornySimp',       url:q=>`/api/hornysimp?term=${q}`,           type:'urls',   key:['urls','titles'] },
      { name:'Porntn',          url:q=>`/api/porntn?term=${q}`,              type:'urls',   key:['urls','titles'] },
      { name:'xxBrits',         url:q=>`/api/xxbrits?term=${q}`,             type:'urls',   key:['urls','titles'] },
      { name:'BitchesGirls',    url:q=>`/api/bitchesgirls?term=${q}`,        type:'urls',   key:['urls','titles'] },
      { name:'ThotsLife',       url:q=>`/api/thotslife?term=${q}`,           type:'urls',   key:['urls','titles'] },
      { name:'Fapello Gallery', url:q=>`/api/fapello-gallery?album_url=${q}`,type:'gallery' },
      { name:'JPG5 Gallery',    url:q=>`/api/jpg5-gallery?album_url=${q}`,    type:'gallery' }
    ];

    document.addEventListener('DOMContentLoaded', () => {
      initNav(); initFAQ(); initModelsTools(); initBackToTop();
      telegramBtn.addEventListener('click', ()=> window.open('https://t.me/your_telegram_link','_blank'));
      discordBtn.addEventListener('click', ()=> window.open('https://discord.gg/your_discord_link','_blank'));
      jpg5Btn.addEventListener('click', fetchJPG5Album);
      uploadBtn.addEventListener('click', uploadNewModel);
      setFaviconBtn.addEventListener('click', () => {
        const url = faviconInput.value.trim();
        if (!url) return alert('Enter a valid image URL for the tab icon.');
        faviconLink.href = url;
        alert('Favicon updated!');
      });
      if (results.length) {
        renderModels(results);
      }
    });

    // Navigation & search
    function initNav(){
      [menuHome,menuSearch,menuModels,menuFaq,menuTerms].forEach(btn=>{
        btn.onclick=e=>{ e.preventDefault(); showSection(btn.id.replace('menu-','')); };
      });
      searchForm.addEventListener('submit',async e=>{
        e.preventDefault();
        let q = searchIn.value.trim(); if(!q) return;
        let success = await doSearch(q);
        if(!success) return;
        renderSearch([results[results.length-1]]);
        renderModels(results);
        showSection('search');
      });
    }

    async function doSearch(term){
      let model = { name:term, endpoints:[] };
      for(let ep of endpoints){
        if(ep.name==='JPG5 Gallery') continue;
        let url = ep.url(encodeURIComponent(term));
        try{
          let res = await fetch(url), data = await res.json();
          let items = ep.type==='gallery'
                    ? (data.images||[])
                    : (data.albums||[]);
          if(items.length){
            model.endpoints.push({ ...ep, items });
          }
        }catch(err){ console.error('Error fetching', ep.name, err); }
      }
      if(term.startsWith('http')){
        try{
          let res = await fetch(`/api/jpg5-gallery?album_url=${encodeURIComponent(term)}`), data = await res.json();
          if(data.images && data.images.length){
            model.endpoints.push({ name:'JPG5 Gallery', type:'gallery', items:data.images });
          }
        }catch(err){ console.error('Error fetching JPG5', err); }
      }
      if(model.endpoints.length===0){
        alert(`No leaks found for ${term}`);
        return false;
      }
      results.push(model);
      localStorage.setItem('n3xus_results', JSON.stringify(results));
      return true;
    }

    // Render search results
    function renderSearch(list){
      searchGrid.innerHTML = '';
      for(let m of list){
        let thumbEp = m.endpoints.find(e=>e.thumbnail) || m.endpoints.find(e=>e.name==='Erome Gallery');
        let thumb = thumbEp
                   ? (thumbEp.thumbnail || thumbEp.items[0])
                   : DEFAULT_THUMB;
        let card = document.createElement('div');
        card.className = 'model-card';
        card.innerHTML = `
          <img src="${thumb}" alt="${m.name} thumbnail"/>
          <div class="info">
            <h3>${m.name}</h3>
            <p>${m.endpoints.length} sources</p>
          </div>`;
        card.onclick = () => openGallery(m);
        searchGrid.appendChild(card);
      }
    }

    // Render models on the Models page
    function renderModels(list){
      modelsGrid.innerHTML = '';
      list.forEach((m, idx) => {
        let thumbEp = m.endpoints.find(e=>e.thumbnail) || m.endpoints.find(e=>e.name==='Erome Gallery');
        let thumb = thumbEp
                   ? (thumbEp.thumbnail || thumbEp.items[0])
                   : DEFAULT_THUMB;
        let card = document.createElement('div');
        card.className = 'model-card';
        card.innerHTML = `
          <img src="${thumb}" alt="${m.name} thumbnail"/>
          <div class="info">
            <h3>${m.name}</h3>
            <p>${m.endpoints.length} sources</p>
          </div>`;
        card.onclick = () => openGallery(m);
        if(adminMode){
          let delModelBtn = document.createElement('button');
          delModelBtn.className = 'delete-model-btn';
          delModelBtn.innerHTML = '<i class="fas fa-trash"></i>';
          delModelBtn.onclick = e => {
            e.stopPropagation();
            if(confirm(`Delete model "${m.name}" entirely? This cannot be undone.`)){
              results.splice(idx,1);
              localStorage.setItem('n3xus_results', JSON.stringify(results));
              renderModels(results);
              galleryView.style.display = 'none';
              showSection('models');
            }
          };
          card.appendChild(delModelBtn);
        }
        modelsGrid.appendChild(card);
      });
    }

    // Gallery / album view with admin controls
    function openGallery(model){
      showSection(''); galleryView.style.display='block';
      modelTitle.textContent = model.name;
      albumLinks.innerHTML = '';

      model.endpoints.forEach((ep, epi) => {
        let sec = document.createElement('div');
        sec.className = 'endpoint-section';

        // Header + admin buttons
        let header = document.createElement('div');
        header.innerHTML = `<h3>${ep.name} (${ep.items.length})</h3>`;
        if(adminMode){
          let delAlbumBtn = document.createElement('button');
          delAlbumBtn.textContent = 'Delete Album';
          delAlbumBtn.onclick = () => {
            if(confirm(`Delete album "${ep.name}"?`)){
              model.endpoints.splice(epi,1);
              cleanupEmpty(model);
              localStorage.setItem('n3xus_results', JSON.stringify(results));
              renderModels(results);
              openGallery(model);
            }
          };
          let editThumbBtn = document.createElement('button');
          editThumbBtn.textContent = 'Edit Thumb';
          editThumbBtn.onclick = () => {
            let newUrl = prompt('New thumbnail URL:');
            if(newUrl){
              ep.thumbnail = newUrl;
              localStorage.setItem('n3xus_results', JSON.stringify(results));
              renderModels(results);
              openGallery(model);
            }
          };
          header.appendChild(delAlbumBtn);
          header.appendChild(editThumbBtn);
        }
        sec.appendChild(header);

        // Image grid
        let grid = document.createElement('div'); grid.className = 'items-grid';
        ep.items.forEach((item, ii) => {
          let url = (typeof item === 'string') ? item : item.url;
          let thumb = (ep.thumbnail) ? ep.thumbnail : url;
          let container = document.createElement('div');
          container.className = 'item-container';

          let link = document.createElement('a');
          link.href = url; link.target = '_blank';
          let img = document.createElement('img');
          img.src = thumb; img.alt = ep.name;
          link.appendChild(img);
          container.appendChild(link);

          if(adminMode){
            let editBtn = document.createElement('button');
            editBtn.className = 'item-btn';
            editBtn.innerHTML = '<i class="fas fa-edit"></i>';
            editBtn.onclick = () => {
              let newUrl = prompt('New image URL:', url);
              if(newUrl){
                if(typeof item === 'string'){
                  ep.items[ii] = newUrl;
                } else {
                  item.url = newUrl;
                }
                cleanupEmpty(model);
                localStorage.setItem('n3xus_results', JSON.stringify(results));
                openGallery(model);
              }
            };
            let deleteBtn = document.createElement('button');
            deleteBtn.className = 'item-btn';
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.onclick = () => {
              if(confirm('Delete this image?')){
                ep.items.splice(ii,1);
                cleanupEmpty(model);
                localStorage.setItem('n3xus_results', JSON.stringify(results));
                openGallery(model);
              }
            };
            container.appendChild(editBtn);
            container.appendChild(deleteBtn);
          }

          grid.appendChild(container);
        });
        sec.appendChild(grid);
        albumLinks.appendChild(sec);
      });
    }

    // Remove empty albums and models when needed
    function cleanupEmpty(model){
      // Remove any endpoint with zero items
      model.endpoints = model.endpoints.filter(e=>e.items && e.items.length);
      // If model has no endpoints, remove it
      if(model.endpoints.length === 0){
        let mi = results.indexOf(model);
        if(mi !== -1) results.splice(mi,1);
      }
      localStorage.setItem('n3xus_results', JSON.stringify(results));
    }

    backBtn.onclick = () => showSection('search');

    function showSection(sec){
      [intro,searchSec,modelsSec,galleryView,faqSec,termsSec].forEach(el=>el.style.display='none');
      document.querySelectorAll('.sidebar a').forEach(a=>a.classList.remove('active'));
      switch(sec){
        case 'home':   intro.style.display='block';    menuHome.classList.add('active');    break;
        case 'search': searchSec.style.display='block'; menuSearch.classList.add('active');  break;
        case 'models': modelsSec.style.display='block'; menuModels.classList.add('active');  break;
        case 'faq':    faqSec.style.display='block';    menuFaq.classList.add('active');     break;
        case 'terms':  termsSec.style.display='block';  menuTerms.classList.add('active');   break;
      }
    }

    // JPG5 album fetch
    async function fetchJPG5Album(){
      let url = jpg5Input.value.trim(); if(!url) return alert('Enter a JPG5 album URL.');
      try{
        let res = await fetch(`/api/jpg5-gallery?album_url=${encodeURIComponent(url)}`), data = await res.json();
        if(!data.images.length) return alert(`No leaks found for ${url}`);
        let model = { name:url, endpoints:[{ name:'JPG5 Gallery', type:'gallery', items:data.images } ] };
        results.push(model);
        localStorage.setItem('n3xus_results', JSON.stringify(results));
        renderSearch([model]);
        renderModels(results);
        showSection('search');
      }catch(err){ console.error(err); alert('Error fetching JPG5 album.'); }
    }

    // Admin activation (Ctrl+I)
    document.addEventListener('keydown', e=>{
      if(e.ctrlKey && e.key.toLowerCase()==='i'){
        let pwd = prompt('Enter admin password:');
        if(pwd==='cassidy'){
          adminMode = true;
          adminPanel.style.display='block';
          renderModels(results);
          alert('Admin mode enabled.');
        } else alert('Incorrect password.');
      }
    });

    // ZIP-upload handler
    async function uploadNewModel(){
      const name = document.getElementById('new-model-name').value.trim();
      const zipFile = document.getElementById('new-model-zip').files[0];
      if(!name) return alert('Enter a model name.');
      if(!zipFile) return alert('Select a ZIP file.');
      try {
        const zip = await JSZip.loadAsync(zipFile);
        const entries = Object.values(zip.files)
          .filter(f=>!f.dir&&/\.(jpe?g|png|gif|mp4|webm)$/i.test(f.name));
        if(entries.length<20) return alert('ZIP must contain at least 20 images/videos.');
        const urls = [];
        for(const file of entries){
          const blob = await file.async('blob');
          urls.push(URL.createObjectURL(blob));
        }
        results.push({ name, endpoints:[{ name:'Uploaded Model', type:'gallery', items:urls }] });
        localStorage.setItem('n3xus_results', JSON.stringify(results));
        alert('Model uploaded!');
        renderModels(results);
        showSection('models');
      } catch(err){ console.error(err); alert('Error processing ZIP.'); }
    }

    // Models filter & tools
    function initModelsTools(){
      'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(letter=>{
        let btn = document.createElement('button'); btn.textContent=letter;
        btn.onclick=()=>filterModels(letter);
        azList.appendChild(btn);
      });
      filterIn.oninput=()=>filterModels(filterIn.value.trim());
    }
    function filterModels(f){
      for(let card of modelsGrid.children){
        let name=card.querySelector('h3').textContent.toLowerCase();
        if(f.length===1){
          card.style.display = name.startsWith(f.toLowerCase())?'block':'none';
        } else if(f.length>1){
          card.style.display = name.includes(f.toLowerCase())?'block':'none';
        } else card.style.display='block';
      }
    }

    // FAQ accordion
    function initFAQ(){
      faqBtns.forEach(btn=>btn.onclick=()=>{
        let pan=btn.nextElementSibling, ic=btn.querySelector('i');
        document.querySelectorAll('.panel').forEach(p=>p.style.maxHeight=null);
        document.querySelectorAll('.accordion-item i').forEach(i=>i.classList.replace('fa-minus','fa-plus'));
        if(!pan.style.maxHeight){ pan.style.maxHeight=pan.scrollHeight+'px'; ic.classList.replace('fa-plus','fa-minus'); }
      });
    }

    // Back to top
    function initBackToTop(){ backToTop.onclick=()=>window.scrollTo({top:0,behavior:'smooth'}); }
  </script>
</body>
</html>
